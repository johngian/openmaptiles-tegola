# Tegola & OpenMaptiles

## About

This project is aiming to enable the tegola vector tile server to support
serving tiles using the OpenMapTiles schema.

## Installation

### Requirements

- [docker]
- [docker-compose]

### Quickstart

#### Init

Fetch git submodules:

```bash
$ git clone https://github.com/johngian/openmaptiles-tegola.git
$ cd openmaptiles-tegola
$ git submodule update --init
```

#### Build openmaptiles-tools

```bash
$ cd vendor/openmaptiles-tools
$ make build-docker VERSION="tegola-dev"
```

#### Build tegola server image

```bash
$ cd vendor/tegola
$ docker build . -t tegola:latest
```

#### Configure tegola server

There is a quickstart script that runs a similar sequence of `make` aiming to generate tiles
in `MBTiles` format. Just for better understanding of the internals here is a list of commands
that generate our PostGIS data and our tegola config (heavily based on `quickstart.sh`).

```bash
$ cd vendor/openmaptiles
$ make start-db                                        # Start PostGIS server
$ make list-geofabrik                                  # List all areas available to download
$ make download area=planet                            # Planet takes long time to load. Use a different area for dev purposes
$ make all                                             # Bootstraps configuration files
$ make import-data                                     # Import natural earth data, water polygons, lake lines
$ make import-osm                                      # Import OSM data in PostGIS using imposm3
$ make import-borders                                  # Import border geometries PostGIS
$ make import-wikidata                                 # Import wikidata in PostGIS
$ make import-sql                                      # Run SQL scripts for postprocessing
$ make analyze-db                                      # Analyze PostGIS tables
$ make test-perf-null                                  # Testing PostgreSQL tables to match layer definitions metadata
$ make build/tegola.toml TOOLS_VERSION="tegola-dev"    # Generate the tegola config based on the OpenMapTiles schema queries
```

The tegola configuration is under `build/`.
```bash
$ cat build/tegola.toml
```

#### Start tegola server

```bash
$ cd vendor/openmaptiles
$ docker-compose up tegola
```

## Notes

- Currently the setup is relying on the following forks
  - [johngian/openmaptiles-tools@tegola-config](https://github.com/johngian/openmaptiles-tools/tree/tegola-config)
    - Implemented an openmaptile-tool to generate the tegola config
  - [johngian/openmaptiles@tegola-support](https://github.com/johngian/openmaptiles/tree/tegola-support)
    - Added tegola support in the docker-compose setup
    - Added some extra makefile targets to make the bootstrapping process easier
  - [johngian/tegola@mvt-fixes](https://github.com/johngian/tegola/tree/mvt-fixes)
    - Fixed some issues encountered while parsing the MVT SQL generated by openmaptiles

## State

- Currently this is a proof of concept to assess if tegola can serve OpenMapTiles
- For convenience, I based all the work on the submodule forks. If there is interest the patches can be upstreamed
- I manually tested all the process end-to-end and it looks like everything is working as expected
  - `openmaptiles-tools` generates a valid configuration
  - `openmaptiles` bootstrapping process spawns a tegola server
  - `tegola` serves tiles based on OpenMapTiles

As a more tangible test, I managed to render maps with `osm-bright` style using the `maputnik` map editor as a frontend.

[docker]: https://www.docker.com/ 'docker'
[docker-compose]: https://docs.docker.com/compose/install/ 'docker-compose'
